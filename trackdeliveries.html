<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Track Your Delivery | FikaConnect - Real-Time Logistics</title>
    <meta name="description" content="Track your FikaConnect delivery in real-time on Google Maps. Get live status updates, driver info, and proof of delivery.">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css" />

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqHX39xTBqnu47exoR9-xWftDMyKHWYFo&libraries=places&callback=initMap" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
            authDomain: "fika-connect-5f844.firebaseapp.com",
            projectId: "fika-connect-5f844",
            storageBucket: "fika-connect-5f844.appspot.com",
            messagingSenderId: "124223307329",
            appId: "1:124223307329:web:76c547b91dcd25205550c0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables for map elements
        let map;
        let driverMarker;
        let pickupMarker, dropoffMarker; // Added for pickup/dropoff points
        let directionsService, directionsRenderer;
        let watchId; // To store the ID of geolocation watchPosition

        // Get params from URL or localStorage
        let currentDeliveryId = new URLSearchParams(location.search).get("id");
        let currentUserRole = new URLSearchParams(location.search).get("role");

        // Elements
        const manualPanel = document.getElementById("manualPanel");
        const deliveryIdInput = document.getElementById("deliveryId");
        const userRoleSelect = document.getElementById("userRole");
        const trackDeliveryBtn = document.getElementById("trackDeliveryBtnManual");

        const mapContainer = document.getElementById("map");
        const deliveryInfoSection = document.getElementById("deliveryInfo");
        const deliveryStatusSpan = document.getElementById("deliveryStatus");
        const etaTextSpan = document.getElementById("etaText");
        const driverInfoDiv = document.getElementById("driverInfo");
        const driverNameSpan = document.getElementById("driverName");
        const driverPhoneSpan = document.getElementById("driverPhone");
        const vehicleDetailsSpan = document.getElementById("vehicleDetails");
        const proofImageInput = document.getElementById("proofImage");
        const uploadProofButton = document.getElementById("uploadProofBtn");
        const markDeliveredButton = document.getElementById("markDeliveredBtn");
        const proofOfDeliverySection = document.getElementById("proofOfDeliverySection");
        const proofImageDisplay = document.getElementById("proofImageDisplay");


        // --- Initialize Map ---
        window.initMap = () => {
            map = new google.maps.Map(mapContainer, {
                center: { lat: 0.3476, lng: 32.5825 }, // Default to Kampala, Uganda
                zoom: 8,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions: { strokeColor: '#00b894', strokeWeight: 5, strokeOpacity: 0.7 }, // FikaConnect color
                suppressMarkers: true // We'll add custom markers
            });

            // If ID and role are in URL, auto-initialize tracking
            if (currentDeliveryId && currentUserRole) {
                manualPanel.style.display = "none"; // Hide manual input
                startTracking(currentDeliveryId, currentUserRole);
            } else {
                manualPanel.style.display = "flex"; // Show manual input if no params
            }
        };

        // --- Manual Tracking Initialization ---
        trackDeliveryBtn.addEventListener('click', () => {
            const id = deliveryIdInput.value.trim();
            const role = userRoleSelect.value;

            if (!id) {
                alert("Please enter a Delivery ID to track.");
                return;
            }
            // Navigate with parameters to ensure URL reflects state
            window.location.href = `trackdeliveries.html?id=${id}&role=${role}`;
        });


        // --- Start Tracking Main Logic ---
        async function startTracking(deliveryId, userRole) {
            deliveryInfoSection.style.display = "block"; // Show info panel
            mapContainer.textContent = "Loading map and delivery details..."; // Loading message

            // Store current delivery ID in local storage for persistence
            localStorage.setItem("lastDeliveryId", deliveryId);

            const deliveryRef = doc(db, "bookings", deliveryId); // Assuming "bookings" is your collection name

            onSnapshot(deliveryRef, async (snapshot) => {
                if (!snapshot.exists()) {
                    mapContainer.textContent = "Delivery not found.";
                    deliveryInfoSection.style.display = "none";
                    return;
                }
                const data = snapshot.data();
                console.log("Live Delivery Data:", data);

                updateDeliveryInfo(data, userRole);
                updateMap(data, userRole);

                // Driver-specific actions & location updates
                if (userRole === "driver") {
                    driverActionsVisibility(data.status);
                    if (data.status !== "Delivered") { // Only update location if not delivered
                        if (!watchId) { // Prevent multiple watchPosition calls
                            watchId = navigator.geolocation.watchPosition(
                                async (position) => {
                                    const coords = {
                                        latitude: position.coords.latitude,
                                        longitude: position.coords.longitude
                                    };
                                    // Update Firestore with driver's current location
                                    await updateDoc(deliveryRef, {
                                        currentLocation: coords,
                                        status: data.status === "Pending" ? "Assigned - En Route to Pickup" : data.status // Auto-update status for driver
                                    });
                                },
                                (error) => {
                                    console.error("Geolocation error:", error);
                                    alert("Could not get your location. Please enable location services.");
                                },
                                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                            );
                        }
                    } else {
                        // Stop watching position if delivery is complete
                        if (watchId) navigator.geolocation.clearWatch(watchId);
                    }
                } else { // Sender or Receiver
                    driverActionsVisibility("hide"); // Hide driver specific buttons
                }
            }, (error) => {
                console.error("Error fetching live delivery data:", error);
                mapContainer.textContent = "Error loading delivery details.";
                deliveryInfoSection.style.display = "none";
            });
        }

        // --- Update UI with Delivery Info ---
        function updateDeliveryInfo(data, userRole) {
            deliveryStatusSpan.textContent = data.status || "Unknown";
            etaTextSpan.textContent = data.eta || "Calculating...";

            // Display full booking details
            document.getElementById("bookingDetails").innerHTML = `
                <p><strong>Booking ID:</strong> ${currentDeliveryId}</p>
                <p><strong>Pickup:</strong> ${data.pickupLocation}</p>
                <p><strong>Drop-off:</strong> ${data.dropoffLocation}</p>
                <p><strong>Cargo:</strong> ${data.cargoType} (${data.packageDescription})</p>
                <p><strong>Vehicle:</strong> ${data.vehicleType}</p>
                <p><strong>Urgency:</strong> ${data.urgency}</p>
                ${data.senderNotes ? `<p><strong>Notes:</strong> ${data.senderNotes}</p>` : ''}
            `;

            // Driver Info (visible to sender/receiver if assigned)
            if (data.driverId && data.driverName && data.driverPhone && data.vehiclePlate) {
                driverInfoDiv.style.display = "block";
                driverNameSpan.textContent = data.driverName;
                driverPhoneSpan.textContent = data.driverPhone;
                vehicleDetailsSpan.textContent = `${data.vehicleType} (${data.vehiclePlate})`;
            } else {
                driverInfoDiv.style.display = "none";
                if (data.status === "Pending") {
                     driverInfoDiv.innerHTML = `<p class="info-message">Waiting for a driver to be assigned...</p>`;
                     driverInfoDiv.style.display = "block";
                }
            }

            // Proof of Delivery Display (visible to all if delivered)
            if (data.status === "Delivered" && data.proofImage) {
                proofOfDeliverySection.style.display = "block";
                proofImageDisplay.src = data.proofImage;
                proofImageDisplay.alt = `Proof of Delivery for ${currentDeliveryId}`;
            } else {
                proofOfDeliverySection.style.display = "none";
            }
        }

        // --- Update Map Elements ---
        function updateMap(data, userRole) {
            // Add custom markers for pickup and dropoff
            if (!pickupMarker && data.pickupLocation) {
                // You'd need to geocode data.pickupLocation to get lat/lng if not already stored
                // For now, let's assume we get lat/lng from a geocoding service or from the booking data.
                // For demonstration, let's use fixed coords or derive from Google Places Autocomplete data if stored.
                // Assuming you store {lat, lng} for pickupLocation and dropoffLocation in Firebase.
                // For this example, I'll use a dummy geocoding for string addresses, which is not ideal for production.
                getLatLng(data.pickupLocation, (pickupLatLng) => {
                    if (pickupLatLng) {
                        pickupMarker = new google.maps.Marker({
                            position: pickupLatLng,
                            map: map,
                            icon: 'http://googleusercontent.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1x.png&textsize=12&text_color=white&color=black&t=normal', // Default Google Pin
                            title: `Pickup: ${data.pickupLocation}`
                        });
                        if (!driverMarker) map.setCenter(pickupLatLng); // Center if no driver yet
                    }
                });
            }
             if (!dropoffMarker && data.dropoffLocation) {
                getLatLng(data.dropoffLocation, (dropoffLatLng) => {
                    if (dropoffLatLng) {
                        dropoffMarker = new google.maps.Marker({
                            position: dropoffLatLng,
                            map: map,
                            icon: 'http://googleusercontent.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1x.png&textsize=12&text_color=white&color=black&t=normal', // Default Google Pin
                            title: `Drop-off: ${data.dropoffLocation}`
                        });
                    }
                });
            }


            // Display driver marker only if location exists
            if (data.currentLocation && data.currentLocation.latitude && data.currentLocation.longitude) {
                const driverLatLng = new google.maps.LatLng(data.currentLocation.latitude, data.currentLocation.longitude);

                if (!driverMarker) {
                    driverMarker = new google.maps.Marker({
                        position: driverLatLng,
                        map: map,
                        icon: 'http://googleusercontent.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1x.png&textsize=12&text_color=white&color=red&t=normal', // Red truck icon
                        title: "Driver's Current Location"
                    });
                } else {
                    driverMarker.setPosition(driverLatLng);
                }
                map.setCenter(driverLatLng); // Keep map centered on driver

                // Recalculate route if driver location or status changes
                if (data.status === "Assigned - En Route to Pickup" || data.status === "En Route to Drop-off") {
                    calculateAndDisplayRoute(data.pickupLocation, data.dropoffLocation, driverLatLng, data.status);
                } else {
                    directionsRenderer.setDirections({ routes: [] }); // Clear route if not actively driving
                }
            } else {
                if (driverMarker) driverMarker.setMap(null); // Remove driver marker if no location
                mapContainer.textContent = "Driver location not available yet.";
            }
        }

        // --- Geocoding Function (for converting addresses to lat/lng) ---
        // In a production app, you'd ideally store lat/lng directly in Firebase
        // from the Google Places Autocomplete on the booking page.
        const geocoder = new google.maps.Geocoder();
        function getLatLng(address, callback) {
            geocoder.geocode({ 'address': address + ", Uganda" }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    callback(results[0].geometry.location);
                } else {
                    console.error('Geocode was not successful for the following reason: ' + status);
                    callback(null);
                }
            });
        }


        // --- Calculate and Display Route ---
        function calculateAndDisplayRoute(pickup, destination, driverLatLng, status) {
            let origin = driverLatLng; // Start from driver's current location
            let dest = destination;

            if (status === "Assigned - En Route to Pickup") {
                dest = pickup; // If en route to pickup, destination is pickup
            }

            directionsService.route(
                {
                    origin: origin,
                    destination: dest,
                    travelMode: google.maps.TravelMode.DRIVING,
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                        const route = response.routes[0].legs[0];
                        etaTextSpan.textContent = route.duration.text;
                        // You could also update ETA in Firestore here if needed
                    } else {
                        console.error("Directions request failed due to " + status);
                        etaTextSpan.textContent = "ETA N/A";
                    }
                }
            );
        }


        // --- Driver Actions Visibility ---
        function driverActionsVisibility(status) {
            if (currentUserRole === "driver") {
                uploadProofButton.style.display = (status === "En Route to Drop-off" || status === "Delivered") ? "inline-block" : "none";
                proofImageInput.style.display = (status === "En Route to Drop-off" || status === "Delivered") ? "block" : "none";
                markDeliveredButton.style.display = (status === "En Route to Drop-off" || status === "Delivered") ? "inline-block" : "none";
                if (status === "Delivered") {
                    uploadProofButton.style.display = "none";
                    proofImageInput.style.display = "none";
                    markDeliveredButton.style.display = "none";
                }
            } else {
                uploadProofButton.style.display = "none";
                proofImageInput.style.display = "none";
                markDeliveredButton.style.display = "none";
            }
        }


        // --- Upload Proof of Delivery ---
        uploadProofButton.addEventListener('click', async () => {
            const file = proofImageInput.files[0];
            if (!file || !currentDeliveryId) {
                alert("Please select an image file first.");
                return;
            }

            // Disable button and show loading
            uploadProofButton.disabled = true;
            uploadProofButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            try {
                const path = `proofs/${currentDeliveryId}/${file.name}`; // Use unique file name
                const fileRef = sRef(storage, path);
                await uploadBytes(fileRef, file);
                const url = await getDownloadURL(fileRef);

                await updateDoc(doc(db, "bookings", currentDeliveryId), { proofImage: url });
                alert("Proof of delivery uploaded successfully!");
                // Optionally, clear the file input
                proofImageInput.value = '';

            } catch (error) {
                console.error("Error uploading proof:", error);
                alert("Failed to upload proof. Please try again.");
            } finally {
                uploadProofButton.disabled = false;
                uploadProofButton.innerHTML = 'üì∏ Upload Proof of Delivery';
            }
        });


        // --- Mark as Delivered ---
        markDeliveredButton.addEventListener('click', async () => {
            if (!currentDeliveryId) return;

            // Confirm with driver
            if (!confirm("Are you sure you want to mark this delivery as 'Delivered'?")) {
                return;
            }

            markDeliveredButton.disabled = true;
            markDeliveredButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Delivering...';

            try {
                const deliveryRef = doc(db, "bookings", currentDeliveryId);
                await updateDoc(deliveryRef, { status: "Delivered", deliveredAt: Date.now() });

                // Generate and download receipt (PDF generation is complex client-side, this is basic)
                // For a real PDF, consider a library like jsPDF or server-side generation.
                const bookingData = (await getDoc(deliveryRef)).data();
                const receiptContent = `
                    <h3>FikaConnect Delivery Receipt</h3>
                    <p><strong>Delivery ID:</strong> ${currentDeliveryId}</p>
                    <p><strong>Status:</strong> Delivered</p>
                    <p><strong>Delivered At:</strong> ${new Date(Date.now()).toLocaleString()}</p>
                    <p><strong>Pickup:</strong> ${bookingData.pickupLocation}</p>
                    <p><strong>Drop-off:</strong> ${bookingData.dropoffLocation}</p>
                    <p><strong>Cargo:</strong> ${bookingData.cargoType}</p>
                    ${bookingData.proofImage ? `<p>Proof of Delivery: <a href="${bookingData.proofImage}" target="_blank">View Image</a></p>` : ''}
                    <p style="margin-top: 20px;">Thank you for using FikaConnect!</p>
                `;
                const blob = new Blob([receiptContent], { type: "text/html" }); // HTML content for receipt
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `FikaConnect_Receipt_${currentDeliveryId}.html`; // Download as HTML
                link.click();
                URL.revokeObjectURL(link.href); // Clean up

                alert("Delivery marked as complete and receipt generated.");

                // Stop geolocation tracking for this delivery
                if (watchId) navigator.geolocation.clearWatch(watchId);

            } catch (error) {
                console.error("Error marking delivery as delivered:", error);
                alert("Failed to mark as delivered. Please try again.");
            } finally {
                markDeliveredButton.disabled = false;
                markDeliveredButton.innerHTML = '‚úîÔ∏è Mark as Delivered';
            }
        });


        // --- Notification API (for real-time alerts) ---
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body });
            }
        }

        // Example of how you might use notifications (e.g., when status changes)
        // You'd typically compare old status vs new status
        // const oldStatus = ...;
        // if (data.status !== oldStatus) {
        //   showNotification("Delivery Update!", `Your delivery status changed to: ${data.status}`);
        // }

    </script>

</body>
</html>\




  .admin-dashboard-header {
            background-color: var(--primary-color);
            color: #fff;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .admin-dashboard-header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .admin-dashboard-nav {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 10px 0;
            margin-bottom: 30px;
            text-align: center;
        }

        .admin-dashboard-nav a {
            color: var(--dark-text);
            padding: 10px 20px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .admin-dashboard-nav a:hover,
        .admin-dashboard-nav a.active {
            background-color: var(--primary-color);
            color: #fff;
            border-radius: 5px;
        }

        .admin-content {
            padding-bottom: 50px; /* Space for footer */
        }

        .dashboard-section {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }

        .dashboard-section h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.8em;
        }

        .dashboard-summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .summary-card {
            flex: 1;
            min-width: 250px;
            background-color: #e6f3ff; /* Light blue */
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #cceeff;
        }

        .summary-card.green { background-color: #e6ffe6; border-color: #ccffcc; } /* Light green */
        .summary-card.red { background-color: #ffe6e6; border-color: #ffcccc; }   /* Light red */
        .summary-card.yellow { background-color: #fffbe6; border-color: #fffbcc; } /* Light yellow */

        .summary-card .icon {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .summary-card.green .icon { color: #28a745; }
        .summary-card.red .icon { color: #dc3545; }
        .summary-card.yellow .icon { color: #ffc107; }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--dark-text);
        }

        .summary-card .label {
            font-size: 1.1em;
            color: #777;
        }

        /* Basic Table Styling */
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .dashboard-table th, .dashboard-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }

        .dashboard-table th {
            background-color: #f2f2f2;
            font-weight: 600;
            color: #333;
        }

        .dashboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .dashboard-table tr:hover {
            background-color: #f1f1f1;
        }

        .dashboard-table .status-pending { color: #ffc107; font-weight: 600; }
        .dashboard-table .status-completed { color: #28a745; font-weight: 600; }
        .dashboard-table .status-cancelled { color: #dc3545; font-weight: 600; }
        /* Add more status styles as needed */

        .dashboard-table .action-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .dashboard-table .action-btn:hover {
            background-color: #0056b3;
        }

        /* Message for no data */
        .no-data-message {
            text-align: center;
            padding: 30px;
            color: #777;
            font-size: 1.1em;
        }

    </style>