<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book & Track | FikaConnect</title>
    <script>
        // Immediately invoked function to apply dark mode based on localStorage
        (function() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
    /* Enhanced Book New Delivery Styles */
    :root {
        --primary-color: #28a745;
        --primary-dark: #1e7e34;
        --secondary-color: #6c757d;
        --accent-color: #20c997;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-bg: #f8f9fa;
        --dark-text: #212529;
        --border-color: #dee2e6;
        --white: #ffffff;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
        --header-height: 70px;
    }

    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--light-bg);
        color: var(--dark-text);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    body.dark-mode {
        --light-bg: #121212;
        --dark-text: #f8f9fa;
        --border-color: #343a40;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        background-color: var(--light-bg);
        color: var(--dark-text);
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* Header Enhancements */
    .page-header {
        background-color: var(--white);
        box-shadow: var(--card-shadow);
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        height: var(--header-height);
        display: flex;
        align-items: center;
    }

    body.dark-mode .page-header {
        background-color: #1e1e1e;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .logo-container {
        display: flex;
        align-items: center;
    }

    .logo-container h1 {
        margin: 0;
        font-size: 1.6em;
    }

    .logo-container h1 a {
        text-decoration: none;
        color: var(--primary-color);
        font-weight: 700;
        display: flex;
        align-items: center;
    }

    .logo-container h1 a::before {
        content: "ðŸšš";
        margin-right: 10px;
        font-size: 1.5em;
    }

    .main-nav {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .nav-links {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-links a {
        text-decoration: none;
        color: var(--dark-text);
        padding: 10px 15px;
        font-weight: 600;
        transition: var(--transition);
        border-radius: 30px;
        font-size: 0.95em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    body.dark-mode .nav-links a {
        color: var(--white);
    }

    .nav-links a:hover {
        color: var(--white);
        background-color: var(--primary-color);
    }

    .logout-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background-color: var(--danger-color);
        color: var(--white);
        border-radius: 30px;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 0.95em;
    }

    .logout-btn:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    .menu-toggle {
        display: none;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .menu-toggle:hover {
        background: rgba(40, 167, 69, 0.1);
    }

    /* Mobile Menu */
    .mobile-menu {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: 100%;
        background-color: var(--white);
        box-shadow: 0 10px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
        padding: 20px;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
        border-bottom: 1px solid var(--border-color);
    }

    body.dark-mode .mobile-menu {
        background-color: #1e1e1e;
        border-bottom: 1px solid #343a40;
    }

    .mobile-menu.active {
        transform: translateY(0);
    }

    .mobile-nav-links {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .mobile-nav-links a {
        text-decoration: none;
        color: var(--dark-text);
        padding: 12px 15px;
        font-weight: 600;
        transition: var(--transition);
        border-radius: 8px;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    body.dark-mode .mobile-nav-links a {
        color: var(--white);
    }

    .mobile-nav-links a:hover {
        color: var(--white);
        background-color: var(--primary-color);
    }

    .mobile-logout-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        background-color: var(--danger-color);
        color: var(--white);
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 1em;
        justify-content: center;
    }

    .mobile-logout-btn:hover {
        background-color: #c82333;
    }

    /* Main Content */
    main {
        flex-grow: 1;
        padding: 30px 0;
    }

    /* Initial View */
    .initial-view {
        text-align: center;
        margin: 30px auto;
        max-width: 800px;
        background-color: var(--white);
        border-radius: 15px;
        padding: 40px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
    }

    body.dark-mode .initial-view {
        background-color: #1e1e1e;
    }

    .initial-view:hover {
        transform: translateY(-5px);
    }

    .initial-view h2 {
        color: var(--primary-color);
        font-size: 2.2em;
        margin-bottom: 15px;
    }

    .initial-view p {
        color: var(--secondary-color);
        font-size: 1.1em;
        margin-bottom: 25px;
    }

    body.dark-mode .initial-view p {
        color: #adb5bd;
    }

    .initial-view h3 {
        color: var(--primary-color);
        margin: 30px 0 20px;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    #currentLocationMap {
        height: 400px;
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
        background: #f8f9fa;
    }

    body.dark-mode #currentLocationMap {
        border: 1px solid #495057;
        background: #2d2d2d;
    }

    #locationStatus {
        font-weight: 500;
        color: var(--secondary-color);
        padding: 12px 15px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.03);
        display: inline-block;
        margin: 15px 0;
    }

    body.dark-mode #locationStatus {
        background: rgba(255, 255, 255, 0.05);
        color: #adb5bd;
    }

    .skip-button-container {
        margin-top: 30px;
    }

    .secondary-btn {
        padding: 12px 25px;
        font-size: 1.1em;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        background-color: #f0f0f0;
        color: #555;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .secondary-btn {
        background-color: #343a40;
        color: var(--white);
    }

    .secondary-btn:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.dark-mode .secondary-btn:hover {
        background-color: #495057;
    }

    /* Form Section */
    .form-section {
        background-color: var(--white);
        padding: 40px;
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        max-width: 900px;
        margin: 40px auto;
        transition: var(--transition);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    body.dark-mode .form-section {
        background-color: #1e1e1e;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .form-section:hover {
        transform: translateY(-5px);
    }

    /* Tab Navigation */
    .tab-navigation {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }

    body.dark-mode .tab-navigation {
        border-bottom: 1px solid #495057;
    }

    .tab-button {
        background-color: transparent;
        padding: 15px 30px;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--secondary-color);
        border-radius: 8px 8px 0 0;
        margin: 0 5px;
        transition: var(--transition);
        position: relative;
    }

    body.dark-mode .tab-button {
        color: #adb5bd;
    }

    .tab-button.active {
        color: var(--primary-color);
        background-color: rgba(40, 167, 69, 0.1);
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -11px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 3px 3px 0 0;
    }

    .tab-button:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.05);
        color: var(--dark-text);
    }

    body.dark-mode .tab-button:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--white);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--dark-text);
        font-size: 1em;
    }

    body.dark-mode .form-group label {
        color: var(--white);
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1em;
        box-sizing: border-box;
        transition: var(--transition);
        background-color: #f8f9fa;
        color: var(--dark-text);
    }

    body.dark-mode .form-group input[type="text"],
    body.dark-mode .form-group input[type="email"],
    body.dark-mode .form-group input[type="tel"],
    body.dark-mode .form-group input[type="number"],
    body.dark-mode .form-group select,
    body.dark-mode .form-group textarea {
        background-color: #343a40;
        color: var(--white);
        border: 2px solid #495057;
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="email"]:focus,
    .form-group input[type="tel"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        background-color: var(--white);
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1);
    }

    body.dark-mode .form-group input[type="text"]:focus,
    body.dark-mode .form-group input[type="email"]:focus,
    body.dark-mode .form-group input[type="tel"]:focus,
    body.dark-mode .form-group input[type="number"]:focus,
    body.dark-mode .form-group select:focus,
    body.dark-mode .form-group textarea:focus {
        background-color: #2d2d2d;
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .location-input-group {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .location-input-group input {
        flex-grow: 1;
    }

    .location-input-group button {
        padding: 14px;
        border-radius: 10px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
    }

    .location-input-group button:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
    }

    /* Checkbox Group */
    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding: 15px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.02);
        transition: var(--transition);
    }

    body.dark-mode .checkbox-group {
        background: rgba(255, 255, 255, 0.02);
    }

    .checkbox-group:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    body.dark-mode .checkbox-group:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        accent-color: var(--primary-color);
        cursor: pointer;
    }

    .checkbox-group label {
        margin: 0;
        font-weight: 500;
        color: var(--dark-text);
        cursor: pointer;
    }

    body.dark-mode .checkbox-group label {
        color: var(--white);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 20px;
    }

    body.dark-mode .form-actions {
        border-top: 1px solid #495057;
    }

    .primary-btn {
        padding: 14px 28px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        color: white;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .primary-btn:hover:not(:disabled) {
        background: linear-gradient(90deg, var(--primary-dark), #1baa7f);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .primary-btn:disabled {
        background: linear-gradient(90deg, #a5d6b4, #9bd1c0);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .fare-display {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--dark-text);
        text-align: center;
        flex-grow: 1;
    }

    body.dark-mode .fare-display {
        color: var(--white);
    }

    .fare-display span {
        font-size: 1.6em;
        color: var(--primary-color);
        margin-left: 10px;
    }

    /* Map Section */
    #map {
        height: 400px;
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 25px;
        background: #f8f9fa;
    }

    body.dark-mode #map {
        border: 1px solid #495057;
        background: #2d2d2d;
    }

    #mapError {
        color: var(--danger-color);
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        background: rgba(220, 53, 69, 0.1);
        text-align: center;
        font-weight: 500;
        display: none;
    }

    body.dark-mode #mapError {
        background: rgba(220, 53, 69, 0.2);
    }

    /* Booking Message */
    .booking-message {
        margin-top: 25px;
        padding: 18px;
        border-radius: 10px;
        font-weight: 500;
        text-align: center;
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .booking-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .booking-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .booking-message.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    body.dark-mode .booking-message.success {
        background-color: #155724;
        color: #d4edda;
        border: 1px solid #c3e6cb;
    }

    body.dark-mode .booking-message.error {
        background-color: #721c24;
        color: #f8d7da;
        border: 1px solid #f5c6cb;
    }

    body.dark-mode .booking-message.info {
        background-color: #0c5460;
        color: #d1ecf1;
        border: 1px solid #bee5eb;
    }

    /* Distance Display */
    .distance-display {
        font-size: 1.1em;
        color: var(--secondary-color);
        margin-top: 15px;
        text-align: center;
        font-weight: 600;
        padding: 12px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.03);
    }

    body.dark-mode .distance-display {
        background: rgba(255, 255, 255, 0.05);
        color: #adb5bd;
    }

    .distance-display.error {
        color: var(--danger-color);
        background: rgba(220, 53, 69, 0.1);
    }

    body.dark-mode .distance-display.error {
        background: rgba(220, 53, 69, 0.2);
    }

    /* Page Footer */
    .page-footer {
        background-color: var(--dark-text);
        color: #fff;
        text-align: center;
        padding: 25px 0;
        font-size: 0.95em;
        margin-top: auto;
    }

    /* Responsive Improvements */
    @media (max-width: 991px) {
        .menu-toggle {
            display: flex;
        }

        .nav-links,
        .logout-btn {
            display: none;
        }

        .form-section {
            padding: 30px;
        }

        .tab-navigation {
            flex-direction: column;
            align-items: center;
        }

        .tab-button {
            width: 100%;
            text-align: center;
            margin: 5px 0;
            border-radius: 8px;
        }

        .tab-button.active::after {
            display: none;
        }

        .location-input-group {
            flex-direction: column;
        }

        .location-input-group button {
            width: 100%;
        }

        .form-actions {
            flex-direction: column;
        }

        .fare-display {
            order: -1;
            width: 100%;
            margin-bottom: 20px;
        }

        .primary-btn,
        .secondary-btn {
            width: 100%;
            justify-content: center;
        }

        #currentLocationMap,
        #map {
            height: 350px;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 0 15px;
        }

        main {
            padding: 20px 0;
        }

        .initial-view {
            padding: 30px 20px;
        }

        .initial-view h2 {
            font-size: 1.8em;
        }

        .initial-view p {
            font-size: 1em;
        }

        #currentLocationMap,
        #map {
            height: 300px;
        }

        .form-section {
            padding: 25px 20px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
        }

        .checkbox-group {
            padding: 12px;
        }

        .form-actions {
            margin-top: 30px;
            padding-top: 25px;
        }

        .fare-display {
            font-size: 1.2em;
        }

        .fare-display span {
            font-size: 1.4em;
        }
    }

    @media (max-width: 576px) {
        .page-header {
            padding: 10px 0;
        }

        .logo-container h1 {
            font-size: 1.4em;
        }

        .logo-container h1 a::before {
            font-size: 1.2em;
        }

        .initial-view {
            padding: 25px 15px;
        }

        .initial-view h2 {
            font-size: 1.6em;
        }

        .initial-view h3 {
            font-size: 1.3em;
        }

        #currentLocationMap,
        #map {
            height: 250px;
        }

        .form-section {
            padding: 20px 15px;
        }

        .tab-button {
            padding: 12px 15px;
            font-size: 1em;
        }

        .form-group label {
            font-size: 0.95em;
        }

        .primary-btn,
        .secondary-btn {
            padding: 12px 20px;
            font-size: 1em;
        }

        .fare-display {
            font-size: 1.1em;
        }

        .fare-display span {
            font-size: 1.3em;
        }
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .initial-view,
    .form-section {
        animation: fadeIn 0.6s ease-out;
    }

    .form-group {
        animation: fadeIn 0.4s ease-out;
    }

    .form-group:nth-child(2) { animation-delay: 0.1s; }
    .form-group:nth-child(3) { animation-delay: 0.2s; }
    .form-group:nth-child(4) { animation-delay: 0.3s; }
    .form-group:nth-child(5) { animation-delay: 0.4s; }


    .payment-method-section {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
            border: 1px solid var(--border-color);
        }
        
        body.dark-mode .payment-method-section {
            background-color: #1e1e1e;
            border: 1px solid #495057;
        }
        
        .payment-method-section h3 {
            color: var(--primary-color);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        body.dark-mode .payment-option {
            border: 2px solid #495057;
        }
        
        .payment-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        body.dark-mode .payment-option:hover {
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        .payment-option input {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }
        
        .payment-option label {
            cursor: pointer;
            font-weight: 500;
            color: var(--dark-text);
            flex-grow: 1;
        }
        
        body.dark-mode .payment-option label {
            color: var(--white);
        }
        
        .payment-option .payment-icon {
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        
        .payment-instructions {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.03);
            display: none;
        }
        
        body.dark-mode .payment-instructions {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .payment-instructions.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .payment-instructions h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .payment-instructions ul {
            padding-left: 20px;
        }
        
        .payment-instructions li {
            margin-bottom: 8px;
        }
        
        .mobile-money-details {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(32, 201, 151, 0.1);
            display: none;
        }
        
        body.dark-mode .mobile-money-details {
            background-color: rgba(32, 201, 151, 0.15);
        }
        
        .mobile-money-details.active {
            display: block;
        }
        
        .mobile-money-details h4 {
            margin-top: 0;
            color: var(--accent-color);
        }
        
        .account-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }
        
        body.dark-mode .account-info {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .account-info span:first-child {
            font-weight: 600;
        }
        
        .account-info span:last-child {
            font-weight: 700;
            color: var(--primary-color);
        }
              /* ... existing styles ... */
        
        /* Add to your existing CSS */
        .cod-details {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(40, 167, 69, 0.05);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        body.dark-mode .cod-details {
            background-color: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .other-payer-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .other-payer-details {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
</style>

<script>
    // Enhanced mobile menu and dark mode functionality
    document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.querySelector('.menu-toggle');
        const mobileMenu = document.querySelector('.mobile-menu');
        const body = document.body;
        
        // Mobile menu toggle
        if (menuToggle && mobileMenu) {
            menuToggle.addEventListener('click', function() {
                mobileMenu.classList.toggle('active');
            });
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (mobileMenu && mobileMenu.classList.contains('active')) {
                const isClickInsideMenu = mobileMenu.contains(event.target);
                const isClickOnToggle = menuToggle.contains(event.target);
                
                if (!isClickInsideMenu && !isClickOnToggle) {
                    mobileMenu.classList.remove('active');
                }
            }
        });
        
        // Dark mode toggle
        function toggleDarkMode() {
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
        }
        
        // Apply saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            body.classList.add('dark-mode');
        }
        
        // Add dark mode toggle to mobile menu
        const mobileThemeToggle = document.createElement('div');
        mobileThemeToggle.className = 'mobile-theme-toggle';
        mobileThemeToggle.innerHTML = `
            <i class="fas fa-moon"></i>
            <span>Toggle Dark Mode</span>
        `;
        mobileThemeToggle.addEventListener('click', toggleDarkMode);
        
        if (mobileMenu) {
            mobileMenu.appendChild(mobileThemeToggle);
        }
    });
</script>
</head>
<body>

    <header class="page-header">
        <div class="container">
            <h1><a href="landing.html">FikaConnect</a></h1>
            <nav class="main-nav">
                <a href="sender-dashboard.html">Dashboard</a>
                <a href="book-and-track.html">Book New</a>
                <a href="about.html">About Us</a>
                <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="initialView" class="initial-view">
            <h2>Book Your Delivery</h2>
            <p>We'll try to find your current location to help with pickup, or you can skip this step.</p>
            <h3><i class="fas fa-map-marker-alt"></i> Your Current Location</h3>
            <div id="currentLocationMap"></div>
            <p id="locationStatus" class="small-text">Getting your location...</p>
            <input type="hidden" id="currentLocationLat">
            <input type="hidden" id="currentLocationLng">
            <div class="skip-button-container">
                <button type="button" id="skipLocationBtn" class="secondary-btn"><i class="fas fa-arrow-right"></i> Skip Location Selection</button>
            </div>
        </div>

        <div id="bookingFormContainer" class="form-section">
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="direct">Direct Delivery</button>
                <button class="tab-button" data-tab="collection-point">Collection Point Delivery</button>
            </div>

            <div id="direct" class="tab-content active">
                <form id="directDeliveryForm">
                    <h3>Pickup Details</h3>
                    <div class="form-group">
                        <label for="pickupLocation">Pickup Location:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="pickupLocation" placeholder="Enter pickup address" required style="flex-grow: 1;">
                            <button type="button" id="useCurrentLocationBtn" class="secondary-btn" title="Use your detected location"><i class="fas fa-crosshairs"></i></button>
                        </div>
                        <input type="hidden" id="pickupLocationLat">
                        <input type="hidden" id="pickupLocationLng">
                    </div>
                    <div class="form-group">
                        <label for="pickupContactName">Contact Name:</label>
                        <input type="text" id="pickupContactName" placeholder="Sender's name" required>
                    </div>
                    <div class="form-group">
                        <label for="pickupContactPhone">Contact Phone:</label>
                        <input type="tel" id="pickupContactPhone" placeholder="+256XXXXXXXXX" required>
                    </div>

                    <h3>Drop-off Details</h3>
                    <div class="form-group">
                        <label for="dropoffLocation">Drop-off Location:</label>
                        <input type="text" id="dropoffLocation" placeholder="Enter drop-off address" required>
                        <input type="hidden" id="dropoffLocationLat">
                        <input type="hidden" id="dropoffLocationLng">
                    </div>
                    <div class="form-group">
                        <label for="recipientName">Recipient Name:</label>
                        <input type="text" id="recipientName" placeholder="Recipient's name" required>
                    </div>
                    <div class="form-group">
                        <label for="recipientContact">Recipient Phone:</label>
                        <input type="tel" id="recipientContact" placeholder="+256XXXXXXXXX" required>
                    </div>

                    <h3>Parcel Details</h3>
                    <div class="form-group">
                        <label for="parcelType">Parcel Type:</label>
                        <select id="parcelType" required>
                            <option value="">Select parcel type</option>
                            <option value="Documents">Documents</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Food">Food</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="parcelWeight">Weight (kg):</label>
                        <input type="number" id="parcelWeight" placeholder="e.g., 2.5" step="0.1" min="0.1" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="isFragile">
                        <label for="isFragile">Is Fragile?</label>
                    </div>
                </form>
            </div>

            
                        <div id="mobileMoneyDetails" class="mobile-money-details">
                            <h4>Our Mobile Money Accounts</h4>
                            <p>Please use one of the following accounts for your payment:</p>
                            <div class="account-info">
                                <span>MTN:</span>
                                <span>+256 706 864020</span>
                            </div>
                            <div class="account-info">
                                <span>Airtel:</span>
                                <span>+256 752 864020</span>
                            </div>
                            <p><strong>Important:</strong> After payment, please keep your transaction reference number for confirmation.</p>
                        </div>
                    </div>
                </form>
            </div>


            <div id="collection-point" class="tab-content">
                <form id="collectionPointDeliveryForm">
                    <h3>Sender Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpSenderName">Your Name:</label>
                        <input type="text" id="cpSenderName" placeholder="Your name" required>
                    </div>
                    <div class="form-group">
                        <label for="cpSenderContact">Your Phone:</label>
                        <input type="tel" id="cpSenderContact" placeholder="+256XXXXXXXXX" required>
                    </div>

      <div class="form-group">
    <label for="cpPickupLocationSelect">Pickup Collection Point:</label>
    <select id="cpPickupLocationSelect" required>
        <option value="">Select Pickup Collection Point</option>
    </select>
    <input type="hidden" id="cpPickupLocationLat">
    <input type="hidden" id="cpPickupLocationLng">
</div>
<div class="form-group">
    <label for="cpDropoffLocationSelect">Drop-off Collection Point:</label>
    <select id="cpDropoffLocationSelect" required>
        <option value="">Select Drop-off Collection Point</option>
    </select>
    <input type="hidden" id="cpDropoffLocationLat">
    <input type="hidden" id="cpDropoffLocationLng">
</div>

                    <h3>Recipient Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpRecipientName">Recipient Name:</label>
                        <input type="text" id="cpRecipientName" placeholder="Recipient's name" required>
                    </div>
                    <div class="form-group">
                        <label for="cpRecipientContact">Recipient Phone:</label>
                        <input type="tel" id="cpRecipientContact" placeholder="+256XXXXXXXXX" required>
                    </div>
                  

                    <h3>Parcel Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpParcelType">Parcel Type:</label>
                        <select id="cpParcelType" required>
                            <option value="">Select parcel type</option>
                            <option value="Documents">Documents</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Food">Food</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cpParcelWeight">Weight (kg):</label>
                        <input type="number" id="cpParcelWeight" placeholder="e.g., 2.5" step="0.1" min="0.1" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="cpIsFragile">
                        <label for="cpIsFragile">Is Fragile?</label>
                    </div>
                </form>
            </div>


    <div class="payment-method-section">
        <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
        <div class="payment-options">
            <div class="payment-option">
                <input type="radio" id="cashPayment" name="paymentMethod" value="Cash on Delivery" checked>
                <label for="cashPayment">Cash on Delivery</label>
                <i class="fas fa-money-bill-wave payment-icon"></i>
            </div>
            <div class="payment-option">
                <input type="radio" id="mobileMoneyPayment" name="paymentMethod" value="Mobile Money">
                <label for="mobileMoneyPayment">Mobile Money (Manual Transfer)</label>
                <i class="fas fa-mobile-alt payment-icon"></i>
            </div>
        </div>
        
        <!-- Cash on Delivery Details -->
        <div id="codDetails" class="cod-details">
            <div class="form-group">
                <label for="codPayer">Who will pay?</label>
                <select id="codPayer" name="codPayer">
                    <option value="recipient">Recipient</option>
                    <option value="other">Other Person</option>
                </select>
            </div>
            
            <div id="otherPayerDetails" class="other-payer-details" style="display: none;">
                <div class="form-group">
                    <label for="otherPayerName">Payer's Name</label>
                    <input type="text" id="otherPayerName" name="otherPayerName" placeholder="Enter payer's name">
                </div>
                <div class="form-group">
                    <label for="otherPayerContact">Payer's Contact</label>
                    <input type="tel" id="otherPayerContact" name="otherPayerContact" placeholder="+256XXXXXXXXX">
                </div>
            </div>
        </div>
        
        <div id="mobileMoneyInstructions" class="payment-instructions">
            <h4>How Mobile Money Payment Works</h4>
            <p>After booking, you'll receive instructions to complete your payment via mobile money:</p>
            <ul>
                <li>You will receive a payment request on your phone</li>
                <li>Complete the transfer to our verified mobile money account</li>
                <li>Our team will confirm receipt of payment</li>
                <li>Your delivery will be processed immediately after payment confirmation</li>
            </ul>
        </div>
        
        <div id="mobileMoneyDetails" class="mobile-money-details">
            <h4>Our Mobile Money Accounts</h4>
            <p>Please use one of the following accounts for your payment:</p>
            <div class="account-info">
                <span>MTN:</span>
                <span>+256 706 864020</span>
            </div>
            <div class="account-info">
                <span>Airtel:</span>
                <span>+256 752 864020</span>
            </div>
            <p><strong>Important:</strong> After payment, please keep your transaction reference number for confirmation.</p>
        </div>
    </div>
            <div id="map"></div>
            <p id="mapError" style="color: red; display: none; margin-top: 10px;">Map could not load or find location.</p>

            <div id="bookingMessage" class="booking-message" style="display: none;"></div>

            <div class="form-actions">
                <button type="button" id="calculatePriceBtn" class="secondary-btn"><i class="fas fa-calculator"></i> Calculate Fare</button>
                <div class="fare-display">
                    Fare: <span id="fareAmount">UGX 0</span>
                </div>
                <button type="submit" id="bookNowBtn" class="primary-btn" disabled><i class="fas fa-truck-fast"></i> Book Now</button>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <p>&copy; 2025 FikaConnect â€” Smart Logistics for East Africa</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script type="module">
    'use strict';

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, getDocs, GeoPoint, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
            authDomain: "fika-connect-5f844.firebaseapp.com",
            projectId: "fika-connect-5f844",
            storageBucket: "fika-connect-5f844.appspot.com",
            messagingSenderId: "124223307329",
            appId: "1:124223307329:web:76c547b91dcd25205550c0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const initialView = document.getElementById('initialView');
        const currentLocationMap = document.getElementById('currentLocationMap');
        const locationStatus = document.getElementById('locationStatus');
        const skipLocationBtn = document.getElementById('skipLocationBtn');
        const bookingFormContainer = document.getElementById('bookingFormContainer');

        // Hidden inputs for current location
        const currentLocationLat = document.getElementById('currentLocationLat');
        const currentLocationLng = document.getElementById('currentLocationLng');

        // Direct Delivery Form Elements
        const directDeliveryForm = document.getElementById('directDeliveryForm');
        const pickupLocationInput = document.getElementById('pickupLocation');
        const dropoffLocationInput = document.getElementById('dropoffLocation');
        const pickupContactNameInput = document.getElementById('pickupContactName');
        const pickupContactPhoneInput = document.getElementById('pickupContactPhone');
        const recipientNameInput = document.getElementById('recipientName');
        const recipientContactInput = document.getElementById('recipientContact');
        const parcelTypeInput = document.getElementById('parcelType');
        const parcelWeightInput = document.getElementById('parcelWeight');
        const isFragileCheckbox = document.getElementById('isFragile');
        // Hidden inputs for Direct Delivery
        const pickupLocationLat = document.getElementById('pickupLocationLat');
        const pickupLocationLng = document.getElementById('pickupLocationLng');
        const dropoffLocationLat = document.getElementById('dropoffLocationLat');
        const dropoffLocationLng = document.getElementById('dropoffLocationLng');

        // Collection Point Delivery Form Elements
        const collectionPointDeliveryForm = document.getElementById('collectionPointDeliveryForm');
        const cpSenderNameInput = document.getElementById('cpSenderName');
        const cpSenderContactInput = document.getElementById('cpSenderContact');
        const cpPickupLocationSelect = document.getElementById('cpPickupLocationSelect');
        const cpDropoffLocationSelect = document.getElementById('cpDropoffLocationSelect');
        const cpRecipientNameInput = document.getElementById('cpRecipientName');
        const cpRecipientContactInput = document.getElementById('cpRecipientContact');
        const cpParcelTypeInput = document.getElementById('cpParcelType');
        const cpParcelWeightInput = document.getElementById('cpParcelWeight');
        const cpIsFragileCheckbox = document.getElementById('cpIsFragile');
    
        // Hidden inputs for Collection Point Delivery
        const cpPickupLocationLat = document.getElementById('cpPickupLocationLat');
        const cpPickupLocationLng = document.getElementById('cpPickupLocationLng');
        const cpDropoffLocationLat = document.getElementById('cpDropoffLocationLat');
        const cpDropoffLocationLng = document.getElementById('cpDropoffLocationLng');

        let allCollectionPoints = [];

        // --- Function to Fetch and Populate Collection Points ---
        async function fetchCollectionPoints() {
            try {
                const querySnapshot = await getDocs(collection(db, "collectionPoints"));
                allCollectionPoints = [];
                querySnapshot.forEach(doc => {
                    allCollectionPoints.push({ id: doc.id, ...doc.data() });
                });

                populateCollectionSelect(cpPickupLocationSelect, "Select Pickup Collection Point");
                populateCollectionSelect(cpDropoffLocationSelect, "Select Drop-off Collection Point");

                console.log("Collection points fetched and populated successfully.");
            } catch (error) {
                console.error("Error fetching collection points:", error);
                mapError.textContent = `Error loading collection points: ${error.message}`;
                mapError.style.display = 'block';
            }
        }

        function populateCollectionSelect(selectElement, defaultOptionText) {
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            if (allCollectionPoints.length === 0) {
                selectElement.innerHTML += '<option value="" disabled>No collection points available</option>';
                return;
            }
            allCollectionPoints.forEach(point => {
                const option = document.createElement('option');
                option.value = point.id;
                option.textContent = point.name;
                if (point.geopoint && typeof point.geopoint.latitude === 'number' && typeof point.geopoint.longitude === 'number') {
                    option.dataset.lat = point.geopoint.latitude;
                    option.dataset.lng = point.geopoint.longitude;
                }
                selectElement.appendChild(option);
            });
        }

        // --- Event Listeners for Collection Point Selects ---
        cpPickupLocationSelect.addEventListener('change', () => {
            const selectedOption = cpPickupLocationSelect.options[cpPickupLocationSelect.selectedIndex];
            document.getElementById('cpPickupLocationLat').value = selectedOption.dataset.lat || '';
            document.getElementById('cpPickupLocationLng').value = selectedOption.dataset.lng || '';
        });

        cpDropoffLocationSelect.addEventListener('change', () => {
            const selectedOption = cpDropoffLocationSelect.options[cpDropoffLocationSelect.selectedIndex];
            document.getElementById('cpDropoffLocationLat').value = selectedOption.dataset.lat || '';
            document.getElementById('cpDropoffLocationLng').value = selectedOption.dataset.lng || '';
        });

        // Common DOM Elements
        const logoutBtn = document.getElementById('logoutBtn');
        const calculatePriceBtn = document.getElementById('calculatePriceBtn');
        const fareAmountSpan = document.getElementById('fareAmount');
        const bookNowBtn = document.getElementById('bookNowBtn');
        const bookingMessageDiv = document.getElementById('bookingMessage');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // New elements for location input enhancement
        const mapContainer = document.getElementById('map');
        const mapError = document.getElementById('mapError');
        const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn');

        // Payment method elements
        const codPayerSelect = document.getElementById('codPayer');
        const otherPayerDetails = document.getElementById('otherPayerDetails');

        // --- Global Variables ---
        let CURRENT_USER_ID = null;
        let CURRENT_USER_NAME = "Sender";
        let CURRENT_USER_CONTACT = "";
        let selectedDeliveryType = 'direct_delivery';
        let calculatedFare = 0;
        let calculatedDistanceKm = 0;

        let initialLeafletMap = null;
        let deliveryLeafletMap = null;
        let pickupMarker = null;
        let dropoffMarker = null;

        // --- Event Listeners ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.href = 'login.html';
            });
        }

        // Skip Location Button Event Listener
        skipLocationBtn.addEventListener('click', handleSkipLocation);

        // Calculate Price Button Event Listener
        calculatePriceBtn.addEventListener('click', calculatePrice);

        // Booking Button Event Listener
        bookNowBtn.addEventListener('click', async (event) => {
            event.preventDefault();

            let formIsValid = false;
            if (selectedDeliveryType === 'direct_delivery') {
                formIsValid = directDeliveryForm.checkValidity();
            } else {
                formIsValid = collectionPointDeliveryForm.checkValidity();
            }

            if (!formIsValid) {
                if (selectedDeliveryType === 'direct_delivery') directDeliveryForm.reportValidity();
                else collectionPointDeliveryForm.reportValidity();
                showBookingMessage("Please fill in all required fields.", 'error');
                return;
            }

            if (calculatedFare <= 0) {
                showBookingMessage("Please calculate the fare first. Fare cannot be zero.", 'error');
                return;
            }

            bookNowBtn.disabled = true;
            const originalText = bookNowBtn.innerHTML;
            bookNowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';

            try {
                await bookDelivery();
                showBookingMessage("Delivery booked successfully! Redirecting...", 'success');
                sessionStorage.setItem('fikaConnectBookingFare', calculatedFare.toString());
                setTimeout(() => {
                    window.location.href = 'sender-active-deliveries.html';
                }, 2000);
            } catch (error) {
                console.error("Error booking delivery:", error);
                showBookingMessage("Failed to book delivery. Please try again. Error: " + error.message, 'error');
                bookNowBtn.disabled = false;
                bookNowBtn.innerHTML = originalText;
            }
        });

        // Payment method selection handlers
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const mobileMoneyInstructions = document.getElementById('mobileMoneyInstructions');
                const mobileMoneyDetails = document.getElementById('mobileMoneyDetails');
                const codDetails = document.getElementById('codDetails');
                
                if (this.value === 'Mobile Money' && this.checked) {
                    codDetails.style.display = 'none';
                    mobileMoneyInstructions.classList.add('active');
                    mobileMoneyDetails.classList.add('active');
                } else if (this.value === 'Cash on Delivery' && this.checked) {
                    codDetails.style.display = 'block';
                    mobileMoneyInstructions.classList.remove('active');
                    mobileMoneyDetails.classList.remove('active');
                }
            });
        });

        // Handle COD payer selection
        if (codPayerSelect) {
            codPayerSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    otherPayerDetails.style.display = 'block';
                } else {
                    otherPayerDetails.style.display = 'none';
                }
            });
        }

        // --- Tab Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                const targetTab = document.getElementById(button.dataset.tab);
                if (targetTab) {
                    targetTab.classList.add('active');
                    selectedDeliveryType = button.dataset.tab === 'direct' ? 'direct_delivery' : 'collection_point_pickup';
                    resetFareAndBooking();

                    if (selectedDeliveryType === 'direct_delivery') {
                        mapContainer.style.display = 'block';
                        if (!deliveryLeafletMap) {
                             initDeliveryMap({ lat: 0.347596, lng: 32.582520 });
                        }
                        if (pickupMarker && dropoffMarker) {
                            const group = new L.featureGroup([pickupMarker, dropoffMarker]);
                            deliveryLeafletMap.fitBounds(group.getBounds().pad(0.5));
                        } else if (pickupMarker) {
                            deliveryLeafletMap.setView(pickupMarker.getLatLng(), 13);
                        } else if (dropoffMarker) {
                            deliveryLeafletMap.setView(dropoffMarker.getLatLng(), 13);
                        }
                    } else {
                        mapContainer.style.display = 'none';
                        if (deliveryLeafletMap) {
                            deliveryLeafletMap.remove();
                            deliveryLeafletMap = null;
                            pickupMarker = null;
                            dropoffMarker = null;
                        }
                    }
                }
            });
        });

        // Use Current Location Button Event Listener
        if (useCurrentLocationBtn) {
            useCurrentLocationBtn.addEventListener('click', () => {
                const lat = currentLocationLat.value;
                const lng = currentLocationLng.value;
                if (lat && lng) {
                    const latLng = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    L.Control.Geocoder.nominatim().reverse(latLng, deliveryLeafletMap.options.crs.scale(deliveryLeafletMap.getZoom()), function(results) {
                        let addressName = `${latLng.lat.toFixed(4)}, ${latLng.lng.toFixed(4)}`;
                        if (results && results.length > 0) {
                            addressName = results[0].name || results[0].address.road || results[0].address.country;
                        }
                        pickupLocationInput.value = addressName;
                        pickupLocationLat.value = latLng.lat;
                        pickupLocationLng.value = latLng.lng;

                        if (deliveryLeafletMap) {
                            if (pickupMarker) deliveryLeafletMap.removeLayer(pickupMarker);
                            pickupMarker = L.marker([latLng.lat, latLng.lng]).addTo(deliveryLeafletMap)
                                .bindPopup(`Pickup: ${addressName}`).openPopup();
                            deliveryLeafletMap.setView([latLng.lat, latLng.lng], 13);
                        }
                        showBookingMessage("Pickup location set to your current location.", 'info');
                    });

                } else {
                    showBookingMessage("Your current location is not yet available. Please wait or enter manually.", 'error');
                }
            });
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                CURRENT_USER_ID = user.uid;
                console.log("Firebase: User is logged in, UID:", user.uid);
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        CURRENT_USER_NAME = userData.name || "Sender";
                        CURRENT_USER_CONTACT = userData.contact || "";

                        if (pickupContactNameInput.value === "") pickupContactNameInput.value = CURRENT_USER_NAME;
                        if (pickupContactPhoneInput.value === "") pickupContactPhoneInput.value = CURRENT_USER_CONTACT;
                        if (cpSenderNameInput.value === "") cpSenderNameInput.value = CURRENT_USER_NAME;
                        if (cpSenderContactInput.value === "") cpSenderContactInput.value = CURRENT_USER_CONTACT;
                    }
                    console.log("Firebase: User data fetched and sender fields auto-filled.");
                } catch (error) {
                    console.error("Firebase: Error fetching user details:", error);
                }
                initCurrentLocationMap();
                initDeliveryMap({ lat: 0.347596, lng: 32.582520 });
                fetchCollectionPoints();
            } else {
                console.log("Firebase: User not logged in, redirecting to login.html");
                window.location.href = 'login.html';
            }
        });

        // --- Geocoding Helper Function ---
        async function geocodeAddress(address) {
            console.log("Nominatim: Attempting to geocode address:", address);
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=ug&limit=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    console.log("Nominatim: Successfully geocoded", address, "to", result.display_name);
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        formatted_address: result.display_name
                    };
                } else {
                    console.warn("Nominatim: No results found for", address);
                    throw new Error(`No geocoding results for ${address}.`);
                }
            } catch (error) {
                console.error("Nominatim: Geocoding error for", address, error);
                throw new Error(`Geocoding failed for ${address}: ${error.message}`);
            }
        }

        // --- Haversine Formula for Distance Calculation ---
        function getHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        // --- Calculate Price Function ---
        async function calculatePrice() {
            console.log("Calculate Price: Function called (using Nominatim & Haversine).");
            resetFareAndBooking();

            let originAddress, destinationAddress;
            let parcelWeight, parcelType, isFragile;
            let currentFormIsValid = true;

            if (selectedDeliveryType === 'direct_delivery') {
                originAddress = pickupLocationInput.value.trim();
                destinationAddress = dropoffLocationInput.value.trim();
                parcelWeight = parseFloat(parcelWeightInput.value);
                parcelType = parcelTypeInput.value;
                isFragile = isFragileCheckbox.checked;

                if (!originAddress || !destinationAddress || isNaN(parcelWeight) || parcelWeight <= 0 || !parcelType || !pickupContactNameInput.value || !pickupContactPhoneInput.value || !recipientNameInput.value || !recipientContactInput.value) {
                    currentFormIsValid = false;
                }
            } else {
                originAddress = cpPickupLocationSelect.options[cpPickupLocationSelect.selectedIndex].text;
                destinationAddress = cpDropoffLocationSelect.options[cpDropoffLocationSelect.selectedIndex].text;
                parcelWeight = parseFloat(cpParcelWeightInput.value);
                parcelType = cpParcelTypeInput.value;
                isFragile = cpIsFragileCheckbox.checked;

                if (!originAddress || !destinationAddress || isNaN(parcelWeight) || parcelWeight <= 0 || !parcelType || !cpSenderNameInput.value || !cpSenderContactInput.value || !cpRecipientNameInput.value || !cpRecipientContactInput.value) {
                    currentFormIsValid = false;
                }
            }

            if (!currentFormIsValid) {
                fareAmountSpan.textContent = `UGX 0`;
                showBookingMessage("Please fill in all required fields to calculate fare.", 'info');
                console.log("Calculate Price: Form not fully valid for calculation.");
                return;
            }

            calculatePriceBtn.disabled = true;
            const originalBtnText = calculatePriceBtn.innerHTML;
            calculatePriceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
            fareAmountSpan.textContent = 'Calculating...';
            showBookingMessage("Calculating fare, please wait...", 'info');

            try {
                console.log("Calculate Price: Starting geocoding for origin and destination via Nominatim.");
                const originCoords = await geocodeAddress(originAddress);
                const destinationCoords = await geocodeAddress(destinationAddress);
                console.log("Calculate Price: Geocoding successful. Calculating distance via Haversine.");

                if (selectedDeliveryType === 'direct_delivery') {
                    if (pickupLocationLat) pickupLocationLat.value = originCoords.lat;
                    if (pickupLocationLng) pickupLocationLng.value = originCoords.lng;
                    if (dropoffLocationLat) dropoffLocationLat.value = destinationCoords.lat;
                    if (dropoffLocationLng) dropoffLocationLng.value = destinationCoords.lng;
                } else {
                    if (cpPickupLocationLat) cpPickupLocationLat.value = originCoords.lat;
                    if (cpPickupLocationLng) cpPickupLocationLng.value = originCoords.lng;
                    if (cpDropoffLocationLat) cpDropoffLocationLat.value = destinationCoords.lat;
                    if (cpDropoffLocationLng) cpDropoffLocationLng.value = destinationCoords.lng;
                }

                calculatedDistanceKm = getHaversineDistance(
                    originCoords.lat, originCoords.lng,
                    destinationCoords.lat, destinationCoords.lng
                );
                console.log(`Calculate Price: Distance: ${calculatedDistanceKm.toFixed(2)} km (Haversine)`);

                const BASE_FARE = 5000;
                const COST_PER_KM = 500;
                const WEIGHT_SURCHARGE_PER_KG = 200;
                const FRAGILE_SURCHARGE = 1000;

                calculatedFare = BASE_FARE + (calculatedDistanceKm * COST_PER_KM);
                calculatedFare += (parcelWeight * WEIGHT_SURCHARGE_PER_KG);

                if (isFragile) {
                    calculatedFare += FRAGILE_SURCHARGE;
                }

                if (parcelType === 'Documents') {
                    calculatedFare -= 500;
                } else if (parcelType === 'Electronics') {
                    calculatedFare += 1500;
                }

                calculatedFare = Math.max(0, Math.round(calculatedFare / 100) * 100);

                fareAmountSpan.textContent = `UGX ${calculatedFare.toLocaleString()}`;
                bookNowBtn.disabled = false;
                showBookingMessage(`Fare: UGX ${calculatedFare.toLocaleString()} (Distance: ${calculatedDistanceKm.toFixed(1)} km)`, 'success');
                console.log("Calculate Price: Fare calculated successfully.");

                if (deliveryLeafletMap) {
                    if (pickupMarker) deliveryLeafletMap.removeLayer(pickupMarker);
                    if (dropoffMarker) deliveryLeafletMap.removeLayer(dropoffMarker);

                    pickupMarker = L.marker([originCoords.lat, originCoords.lng]).addTo(deliveryLeafletMap)
                        .bindPopup(`Pickup: ${originCoords.formatted_address}`).openPopup();
                    dropoffMarker = L.marker([destinationCoords.lat, destinationCoords.lng]).addTo(deliveryLeafletMap)
                        .bindPopup(`Dropoff: ${destinationCoords.formatted_address}`).openPopup();

                    const group = new L.featureGroup([pickupMarker, dropoffMarker]);
                    deliveryLeafletMap.fitBounds(group.getBounds().pad(0.5));
                }

            } catch (error) {
                console.error("Calculate Price: Error in calculatePrice execution:", error);
                fareAmountSpan.textContent = `UGX 0`;
                bookNowBtn.disabled = true;
                showBookingMessage("Could not calculate fare. Please ensure addresses are valid and try again. Error: " + error.message, 'error');
            } finally {
                calculatePriceBtn.disabled = false;
                calculatePriceBtn.innerHTML = originalBtnText;
            }
        }

        // Helper to show messages
        function showBookingMessage(message, type) {
            bookingMessageDiv.textContent = message;
            bookingMessageDiv.className = `booking-message ${type}`;
            bookingMessageDiv.style.display = 'block';
            setTimeout(() => {
                bookingMessageDiv.style.display = 'none';
            }, 5000);
        }

        // Helper to reset fare and disable booking button
        function resetFareAndBooking() {
            calculatedFare = 0;
            calculatedDistanceKm = 0;
            fareAmountSpan.textContent = `UGX 0`;
            bookNowBtn.disabled = true;
            bookingMessageDiv.style.display = 'none';
            console.log("Fare and booking button reset.");
        }

        // --- Book Delivery Function ---
       async function bookDelivery() {
            console.log("Book Delivery: Function called.");
            let bookingData = {};
            let customerId = CURRENT_USER_ID;
            let customerName, customerContact;
            let pickupLocation;
            let dropoffLocation;
            let parcelDetails;
            let recipient;
            let paymentMethod;
            let paymentStatus;
            let codPayer = "recipient";
            let otherPayerName = "";
            let otherPayerContact = "";
            
            try {
                // Get payment method
                const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');
                paymentMethod = paymentMethodElement ? paymentMethodElement.value : 'Cash on Delivery';
                
                // Set payment status based on payment method
                paymentStatus = paymentMethod === 'Cash on Delivery' 
                    ? 'Pending COD Collection' 
                    : 'Pending Manual Confirmation';
                
                // Get COD payer details if COD is selected
                if (paymentMethod === 'Cash on Delivery') {
                    const codPayerSelect = document.getElementById('codPayer');
                    codPayer = codPayerSelect ? codPayerSelect.value : 'recipient';
                    
                    if (codPayer === 'other') {
                        const otherPayerNameInput = document.getElementById('otherPayerName');
                        const otherPayerContactInput = document.getElementById('otherPayerContact');
                        otherPayerName = otherPayerNameInput ? otherPayerNameInput.value : '';
                        otherPayerContact = otherPayerContactInput ? otherPayerContactInput.value : '';
                    }
                }

                if (selectedDeliveryType === 'direct_delivery'){
                    const pLat = parseFloat(pickupLocationLat.value);
                    const pLng = parseFloat(pickupLocationLng.value);
                    const dLat = parseFloat(dropoffLocationLat.value);
                    const dLng = parseFloat(dropoffLocationLng.value);

                    if (isNaN(pLat) || isNaN(pLng) || isNaN(dLat) || isNaN(dLng)) {
                        throw new Error("Pickup or Dropoff coordinates are missing. Please re-calculate fare.");
                    }

                    pickupLocation = {
                        name: pickupLocationInput.value,
                        lat: pLat,
                        lng: pLng,
                        geopoint: new GeoPoint(pLat, pLng)
                    };
                    dropoffLocation = {
                        name: dropoffLocationInput.value,
                        lat: dLat,
                        lng: dLng,
                        geopoint: new GeoPoint(dLat, dLng)
                    };
                    parcelDetails = {
                        type: parcelTypeInput.value,
                        weightKg: parseFloat(parcelWeightInput.value),
                        isFragile: isFragileCheckbox.checked
                    };
                    recipient = {
                        name: recipientNameInput.value,
                        contact: recipientContactInput.value
                    };
                    customerName = pickupContactNameInput.value;
                    customerContact = pickupContactPhoneInput.value;

                } else {
                    const cpPLat = parseFloat(cpPickupLocationLat.value);
                    const cpPLng = parseFloat(cpPickupLocationLng.value);
                    const cpDLat = parseFloat(cpDropoffLocationLat.value);
                    const cpDLng = parseFloat(cpDropoffLocationLng.value);

                     if (isNaN(cpPLat) || isNaN(cpPLng) || isNaN(cpDLat) || isNaN(cpDLng)) {
                        throw new Error("Collection Point Pickup or Dropoff coordinates are missing. Please re-calculate fare.");
                    }

                    pickupLocation = {
                        name: cpPickupLocationSelect.options[cpPickupLocationSelect.selectedIndex].text,
                        lat: cpPLat,
                        lng: cpPLng,
                        geopoint: new GeoPoint(cpPLat, cpPLng)
                    };
                    dropoffLocation = {
                        name: cpDropoffLocationSelect.options[cpDropoffLocationSelect.selectedIndex].text,
                        lat: cpDLat,
                        lng: cpDLng,
                        geopoint: new GeoPoint(cpDLat, cpDLng)
                    };
                    parcelDetails = {
                        type: cpParcelTypeInput.value,
                        weightKg: parseFloat(cpParcelWeightInput.value),
                        isFragile: cpIsFragileCheckbox.checked
                    };
                    recipient = {
                        name: cpRecipientNameInput.value,
                        contact: cpRecipientContactInput.value
                    };
                    customerName = cpSenderNameInput.value;
                    customerContact = cpSenderContactInput.value;
                };

                bookingData = {
                    customerId: customerId,
                    customerName: customerName,
                    customerContact: customerContact,
                    deliveryType: selectedDeliveryType,
                    pickupLocation: pickupLocation,
                    dropoffLocation: dropoffLocation,
                    parcelDetails: parcelDetails,
                    recipient: recipient,
                    fareAmount: calculatedFare,
                    distanceKm: calculatedDistanceKm,
                    status: "Pending Driver Assignment",
                    paymentMethod: paymentMethod,
                    paymentStatus: paymentStatus,
                    codPayer: codPayer,
                    otherPayerName: otherPayerName,
                    otherPayerContact: otherPayerContact,
                    bookingDate: serverTimestamp()
                };

                sessionStorage.setItem('fikaConnectBookingData', JSON.stringify(bookingData));
                console.log("Book Delivery: Booking data stored in sessionStorage:", bookingData);
                await addDoc(collection(db, "bookings"), bookingData);
                console.log("Book Delivery: Booking successfully added to Firestore.");

            } catch (error) {
                console.error("Book Delivery: Error during booking process:", error);
                throw error;
            }
        }

        // --- Handle Skip Location Function ---
        function handleSkipLocation() {
            console.log("Skip Location: Button clicked. Hiding initial view, showing booking form.");
            initialView.style.display = 'none';
            bookingFormContainer.style.display = 'block';
            if (selectedDeliveryType === 'direct_delivery' && !deliveryLeafletMap) {
                initDeliveryMap({ lat: 0.347596, lng: 32.582520 });
            }
        }

        // --- Initial Map & Location (Leaflet) ---
        function initCurrentLocationMap() {
            console.log("Leaflet Map: initCurrentLocationMap called.");
            locationStatus.textContent = "Attempting to get your location...";
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Leaflet Map: Geolocation successful.");
                        const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                        currentLocationLat.value = latLng.lat;
                        currentLocationLng.value = latLng.lng;
                        locationStatus.textContent = "Your approximate location is displayed.";
                        
                        if (initialLeafletMap) initialLeafletMap.remove();
                        currentLocationMap.style.height = '400px';
                        initialLeafletMap = L.map('currentLocationMap').setView([latLng.lat, latLng.lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(initialLeafletMap);

                        L.marker([latLng.lat, latLng.lng]).addTo(initialLeafletMap)
                            .bindPopup("Your approximate location").openPopup();
                        console.log("Leaflet Map: Current Location Map initialized successfully.");
                    },
                    (error) => {
                        console.error("Leaflet Map: Geolocation error:", error);
                        let errorMessage = "Could not get your location. Please allow location access.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Location access denied. Defaulting to Kampala.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Location information unavailable. Defaulting to Kampala.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Location request timed out. Defaulting to Kampala.";
                        }
                        locationStatus.textContent = errorMessage;
                        if (initialLeafletMap) initialLeafletMap.remove();
                        currentLocationMap.style.height = '400px';
                        initialLeafletMap = L.map('currentLocationMap').setView([0.347596, 32.582520], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(initialLeafletMap);
                        L.marker([0.347596, 32.582520]).addTo(initialLeafletMap)
                            .bindPopup("Defaulting to Kampala").openPopup();
                        console.log("Leaflet Map: Current Location Map initialized with default location.");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.warn("Leaflet Map: Geolocation is not supported by this browser.");
                locationStatus.textContent = "Geolocation is not supported by your browser. Defaulting to Kampala.";
                if (initialLeafletMap) initialLeafletMap.remove();
                currentLocationMap.style.height = '400px';
                initialLeafletMap = L.map('currentLocationMap').setView([0.347596, 32.582520], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(initialLeafletMap);
                L.marker([0.347596, 32.582520]).addTo(initialLeafletMap)
                    .bindPopup("Defaulting to Kampala").openPopup();
                console.log("Leaflet Map: Current Location Map initialized with default location.");
            }
        }

        // --- Main Delivery Map (for booking form) ---
        function initDeliveryMap(initialLatLng = { lat: 0.347596, lng: 32.582520 }) {
            console.log("Leaflet Map: Initializing Delivery map at", initialLatLng);
            if (deliveryLeafletMap) {
                deliveryLeafletMap.remove();
            }
            mapContainer.style.height = '300px';
            deliveryLeafletMap = L.map('map').setView([initialLatLng.lat, initialLatLng.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(deliveryLeafletMap);

            L.Control.geocoder({
                collapsed: false,
                placeholder: 'Search location...',
                geocoder: L.Control.Geocoder.nominatim()
            }).on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                const name = e.geocode.name;

                pickupLocationInput.value = name;
                pickupLocationLat.value = latlng.lat;
                pickupLocationLng.value = latlng.lng;

                if (pickupMarker) deliveryLeafletMap.removeLayer(pickupMarker);
                pickupMarker = L.marker(latlng).addTo(deliveryLeafletMap)
                    .bindPopup(`Selected: ${name}`).openPopup();
                deliveryLeafletMap.setView(latlng, 15);
                showBookingMessage(`Pickup location updated to: ${name}`, 'info');

            }).addTo(deliveryLeafletMap);

            deliveryLeafletMap.on('click', function(e) {
                const latlng = e.latlng;
                L.Control.Geocoder.nominatim().reverse(latlng, deliveryLeafletMap.options.crs.scale(deliveryLeafletMap.getZoom()), function(results) {
                    let addressName = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                    if (results && results.length > 0) {
                        addressName = results[0].name || results[0].address.road || results[0].address.country;
                    }

                    pickupLocationInput.value = addressName;
                    pickupLocationLat.value = latlng.lat;
                    pickupLocationLng.value = latlng.lng;

                    if (pickupMarker) deliveryLeafletMap.removeLayer(pickupMarker);
                    pickupMarker = L.marker(latlng).addTo(deliveryLeafletMap)
                        .bindPopup(`Pickup: ${addressName}`).openPopup();
                    showBookingMessage(`Pickup location set by map click: ${addressName}`, 'info');
                });
            });

            console.log("Leaflet Map: Delivery Map initialized successfully.");
        }
    });
</script>
</body>
</html>
